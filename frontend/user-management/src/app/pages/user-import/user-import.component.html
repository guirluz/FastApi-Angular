<mat-card>
  <h3>ðŸ“‚ Importar Usuarios desde Excel</h3>

  <!-- Selector de archivo -->
  <input type="file" (change)="onFileSelected($event)" />

  <!-- Mensaje de validaciÃ³n -->
  <div *ngIf="statusMessage && !taskId"
       class="validation-message"
       [ngClass]="{ 'valid': isFileValid, 'invalid': !isFileValid }">
    <p>{{ statusMessage }}</p>
  </div>

  <!-- NavegaciÃ³n de hojas (solo si hay mÃºltiples hojas validadas) -->
  <div *ngIf="isFileValid && sheets && sheets.length > 0" class="sheet-tabs">
    <span class="sheet-tab"
          *ngFor="let sheet of sheets; let i = index"
          [class.active]="i === selectedSheetIndex"
          [class.excluded]="excludedSheets.has(sheet.sheet_name)"
          (click)="selectSheet(i)">
      {{ i + 1 }} â€” {{ sheet.sheet_name }}
    </span>
  </div>

  <!-- Controles por hoja -->
  <div *ngIf="isFileValid && sheets && sheets.length > 0" class="sheet-actions">
    <button mat-stroked-button color="warn" (click)="toggleExcludeCurrentSheet()">
      {{ sheets[selectedSheetIndex] 
            ? (excludedSheets.has(sheets[selectedSheetIndex].sheet_name) 
                ? 'Incluir esta hoja' 
                : 'Excluir esta hoja') 
            : '' }}
    </button>
    <span class="sheet-meta" *ngIf="sheets[selectedSheetIndex]">
      Registros: {{ sheets[selectedSheetIndex].total_rows }} Â· Columnas: {{ sheets[selectedSheetIndex].columns.join(', ') }}
    </span>
  </div>

  <!-- Preview de datos de la hoja activa -->
  <div *ngIf="isFileValid && previewData && previewData.length > 0" class="preview-container">
    <h4>ðŸ‘€ Vista previa: {{ sheets[selectedSheetIndex]?.sheet_name }}</h4>

    <!-- Tabla dinÃ¡mica segÃºn columnas de la hoja activa -->
    <table mat-table [dataSource]="previewData" class="mat-elevation-z8">

      <ng-container *ngFor="let col of sheets[selectedSheetIndex]?.columns" [matColumnDef]="col">
        <th mat-header-cell *matHeaderCellDef> {{ col }} </th>
        <td mat-cell *matCellDef="let row"> {{ row[col] }} </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="sheets[selectedSheetIndex]?.columns"></tr>
      <tr mat-row *matRowDef="let row; columns: sheets[selectedSheetIndex]?.columns;"></tr>
    </table>
  </div>

  <!-- BotÃ³n de subida -->
  <button mat-raised-button color="primary"
          (click)="uploadFile()"
          [disabled]="!selectedFile || !isFileValid || isUploading">
    {{ isUploading ? 'Procesando...' : 'Subir archivo' }}
  </button>

  <!-- Barra de progreso -->
  <div class="progress-container" *ngIf="taskId || isUploading">
    <p class="progress-message" *ngIf="progress < 100">Progreso: {{ progress }}%</p>
    <p class="progress-message" *ngIf="progress === 100">âœ… ImportaciÃ³n completada</p>

    <mat-progress-bar mode="determinate" [value]="progress"></mat-progress-bar>

    <!-- Spinner mientras sube -->
    <div class="spinner-container" *ngIf="isUploading && progress < 100">
      <mat-spinner diameter="30"></mat-spinner>
    </div>
  </div>
</mat-card>







